<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="manifest.json">
    <title>AJJ Live From Quarantine</title>
    <meta name="description" content="All the AJJ songs live From quarantine" />
    <script src="parsed.js?v=2"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
      body{
        margin: 0;
        padding: 0;
        overflow: hidden;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      }
      button {
        border: 1px solid #000;
        padding: 2px 4px;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        margin: 0;
      }
      button.is-playing {
        background: #000;
        color: #fff;
      }
      h2 {
        margin: 0 10px 0 0;
        font-size: 18px;
      }
      p {
        margin: 0;
      }
      #player, #player-mock {
        height: 390px;
        width: 640px;
        max-width: 100%;
        display: block;
        border-right: 1px solid #000;
        background: #000;
        color: #fff;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        flex-direction: column;
        font-size: 18px;
      }
      #player-mock a,
      #player-mock a:visited {
        color: #fff;
        text-decoration: underline;
      }
      #player {
        display: none;
      }
      #title, #songs {
        width: 636px;
        padding: 0 2px;
        max-width: 100%;
        border-right: 1px solid #000;
      }
      #title {
        margin: 0;
        height: 22px;
        border-bottom: 1px solid #000;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      #songs {
        max-height: calc(100vh - 390px - 22px);
        overflow-y: scroll;
      }
      #songs .buttons {
        display: flex;
        flex-wrap: wrap;
      }
      #songs .video {
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px dashed #000;
      }
      #songs > *:last-child,
      #upnext > *:last-child {
        margin-bottom: 30px;
      }
      #songs button,
      #upnext button {
        display: block;
        padding: 4px 8px;
        margin: 0 2px 2px 0;
        word-break: break-word;
      }
      #right {
        position: absolute;
        left: 640px;
        padding: 2px 2px 0 2px;
        top: 0;
        height: 100vh;
        z-index: 100;
        background: #000;
        width: calc(100vw - 640px - 4px);
      }
      #upnext {
        height: calc(100vh - 20px);
        overflow: scroll;
      }
      #upnext-toggle {
        display: none;
        margin-left: auto;
        height: 20px;
      }
      #upnext-header {
        display: block;
        margin-left: auto;
        color: #fff;
        height: 20px;
      }
      @media screen and (max-width: 740px) {
        #player, #player-mock {
          max-height: 35vh;
        }
        #songs {
          max-height: calc(65vh - 22px);
        }
        .drawer-open #right {
          background: #000;
        }
        #right {
          background: transparent;
          left: initial;
          right: 0;
          width: 30%;
          height: auto;
        }
        .drawer-open #right {
          height: 100vh;
        }
        #upnext {
          display: none;
        }
        #upnext-toggle {
          display: block;
          margin-bottom: 2px;
        }
        #upnext-header {
          display: none;
        }
        .drawer-open #upnext {
          display: block;
        }
        .drawer-open #left {
          width: 70%;
        }
        .drawer-open #title,
        .drawer-open #songs {
          width: auto;
        }
      }
  </style>
  </head>
  <body>
    <div id="left">
      <div id="player-mock">
        <h2>AJJ â€“ Live from Quarantine<br/>Pick a song to start<br/>Then keep picking to add songs to your queue</h2><br/>
<a href="https://venmo.com/bonnseanette" target="_blank">Venmo: @bonnseanette</a>
<a href="https://paypal.me/bonnseanette" target="_blank">Paypal: paypal.me/bonnseanette</a>
<a href="https://cash.app/$bonnseanette" target="_blank">Cash App: $bonnseanette</a>
<a href="http://shop.ajjtheband.com" target="_blank">Merch</a>
</div>
      <div id="player"></div>
      <p id="title">
        <button id="reset">Reset</button>
        <button id="shuffle">Shuffle</button>
        <button id="next">Next</button>
        <span id="nowplaying"></span>
      </p>
      <div id="songs"></div>
    </div>
    <div id="right">
      <button id="upnext-toggle" class="upnext-text">Up next</button>
      <p id="upnext-header" class="upnext-text">Up next</p>
      <div id="upnext"></div>
    </div>

    <script>
      const parseSeconds = (str) => {
        let seconds = 0
        const [min, sec] = str.split(':').map((v) => parseInt(v, 10))
        if (min) seconds += min * 60
        seconds += sec
        return seconds
      }

      const $el = (t, text = '', props = {}) => {
        const el = document.createElement(t)
        el.innerText = text
        if (props.class) {
          el.classList.add(props.class)
          delete props.class
        }
        Object.keys(props).forEach((k) => {
          el[k] = props[k]
        })
        return el
      }

      const $ = (sel) => document.querySelector(sel)
      const $$ = (sel) => document.querySelectorAll(sel)

      const removeNode = (n) => n.parentNode.removeChild(n);

      const parseVideoTitle = (str) => str.replace(/Live from Quarantine\s+-?/i, '').trim()

      const getTitle = ({video, song}) => `${parseVideoTitle(video.title)} - ${song && song.name || 'All'}`

      const playId = ({video, song}) => `b-${video.id}${song ? `-${parseSeconds(song.time.start)}` : ''}`

      const nextItem = (arr, item) => arr[arr.findIndex(i => i === item) + 1]

      const shuffleArray = (a) => {
        let j, x, i;
        for (i = a.length - 1; i > 0; i--) {
            j = Math.floor(Math.random() * (i + 1));
            x = a[i];
            a[i] = a[j];
            a[j] = x;
        }
        return a;
      }

      let player;
      let playing = false;
      let initial = true;
      let nowPlaying = null;
      let upNext = []
      const DATA = window.__DATA
      const $songs =$('#songs')
      const $upnext = $('#upnext')

      const resetQueue = () => {
        upNext = []
        $upnext.innerHTML = '';
        $$('.upnext-text').forEach(n => n.textContent = `Up next`)
      }

      const addShuffleToQueue = () => {
        const shuffledSongs = shuffleArray(DATA.reduce((acc, video) => {
          (video.songs || []).forEach((song) => {
            acc.push({ video, song })
          })
          return acc
        }, []))
        shuffledSongs.forEach((item, index) => {
          if (index === 0) {
            playOrAddToQueue(item)
          } else {
            addToQueue(item)
          }
        })
      }

      const moveToFrontOfQueue = (item) => {
        removeFromQueue(item)
        addToQueue({ video: item.video, song: item.song }, false)
      }

      const removeFromQueue = (item) => {
        const index = upNext.findIndex((i) => i === item)
        upNext.splice(index, 1)
        removeNode($(`#${item.id}`))
        $$('.upnext-text').forEach(n => n.textContent = `Up next (${upNext.length})`)
      }

      const playNextInQueue = () => {
        const next = upNext[0]
        if (next) {
          removeFromQueue(next)
          play(next)
        } else if (nowPlaying) {
          const { video, song } = nowPlaying
          const next = nextItem(video.songs, song)
          if (next) {
            play({ video, song: next })
          } else {
            const nextVideo = nextItem(DATA, video)
            if (nextVideo) {
              play({ video: nextVideo, song: nextVideo.songs[0] })
            } else {
              play({ video: DATA[0], song: DATA[0].songs[0] })
            }
          }
        }
      }

      const addToQueue = ({ video, song }, back = true) => {
        const id = `n-${Math.random().toString().slice(2)}`
        const item = { video, song, id }
        const button = $el('button', getTitle({video,song}), {
          id,
          onclick: () => moveToFrontOfQueue(item)
        })
        if (back) {
          upNext.push(item)
          $upnext.appendChild(button)
        } else {
          upNext.unshift(item)
          $upnext.prepend(button)
        }
        $$('.upnext-text').forEach(n => n.textContent = `Up next (${upNext.length})`)
        // console.log(item, upNext.length)
      }

      const play = ({ video, song }) => {
        if (initial) {
          $('#player').style.display = 'block'
          $('#player-mock').style.display = 'none'
        }

        const v = {
          videoId: video.id,
        }

        if (song) {
          if (song.time.start) {
            v.startSeconds = parseSeconds(song.time.start)
          }
          const next = nextItem(video.songs, song)
          const end = song.time.end || next ? next.time.start : null
          if (end) {
            v.endSeconds = parseSeconds(end)
          }
        }

        nowPlaying = { video, song }
        $('#nowplaying').innerText = getTitle({video, song})
        $$('.play-button').forEach(n => n.classList.remove('is-playing'))

        const buttonId = `#${playId({ video, song })}`
        $(buttonId).classList.add('is-playing')
        $(buttonId).parentNode.parentNode.scrollIntoView()

        // debug queue
        // v.endSeconds = v.startSeconds + 10

        console.log('loadVideoById', v)
        player.loadVideoById(v)
       
      }

      const playOrAddToQueue = ({ video, song }) => {
        console.log('play or up next', playing, upNext.length)
        if (!playing && upNext.length === 0) {
          play({ video, song })
        } else {
          addToQueue({ video, song })
        }
      }

      DATA.forEach(video => {
        const $videoHolder = $el('div', '', { class: 'video' })
        $videoHolder.appendChild($el('h2', parseVideoTitle(video.title)))

        if (!video.songs) {
          $videoHolder.appendChild($el('p', 'No timestamps for this video'))
        }

        const $buttonHolder = $el('div', '', { class: 'buttons' })

        $buttonHolder.appendChild($el('button', '+PLAY ALL+', {
          id: playId({ video }),
          class: 'play-button',
          onclick: () => playOrAddToQueue({ video })
        }))

        ;(video.songs || []).forEach((song) => {
          $buttonHolder.appendChild($el('button', song.name, {
            id: playId({ video, song }),
            class: 'play-button',
            onclick: () => playOrAddToQueue({
              video,
              song
            })
          }))
        })

        $videoHolder.appendChild($buttonHolder)
        $songs.appendChild($videoHolder)
      })

      
      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
          height: '390',
          width: '640',
          playerVars: { 'autoplay': 0, 'controls': 0, rel: 0, playsinline: 1, modestbranding: 1 },
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });
      }

      function onPlayerReady(event) {
        console.log('ready', event)
      }

      function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING) {
          console.log('playing', event)
          playing = true
        }
        else if (event.data === YT.PlayerState.ENDED && playing) {
          console.log('ended', event)
          playing = false
          playNextInQueue()
        } else if (event.data === YT.PlayerState.PAUSED) {
          console.log('paused', event)
          playing = false
        }
      }

      $('#shuffle').addEventListener('click', addShuffleToQueue)
      $('#next').addEventListener('click', playNextInQueue)
      $('#reset').addEventListener('click', resetQueue)
      $('#upnext-toggle').addEventListener('click', () => {
        document.body.classList.toggle('drawer-open')
      })
    </script>
  </body>
</html>