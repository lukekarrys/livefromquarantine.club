<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="manifest.json">
    <title>AJJ Live From Quarantine</title>
    <meta name="description" content="All the AJJ songs live From quarantine" />
    <script src="parsed.js?v=2"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
      body{
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      button {
        border: 1px solid #000;
        padding: 2px 4px;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        margin: 0;
      }
      h2 {
        margin: 0 10px 0 0;
        font-size: 18px;
      }
      p {
        margin: 0;
      }
      iframe {
        max-width: 100%;
        display: block;
        border-right: 1px solid #000;
      }
      #title, #songs {
        width: 636px;
        padding: 0 2px;
        max-width: 100%;
        border-right: 1px solid #000;
      }
      #title {
        margin: 0;
        height: 22px;
        border-bottom: 1px solid #000;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      #songs {
        max-height: calc(100vh - 390px - 22px);
        overflow-y: scroll;
      }
      #songs .buttons {
        display: flex;
        flex-wrap: wrap;
      }
      #songs > *:last-child,
      #upnext > *:last-child {
        margin-bottom: 30px;
      }
      #songs button,
      #upnext button {
        display: block;
        padding: 4px 8px;
        margin: 0 2px 2px 0;
        word-break: break-word;
      }
      #right {
        position: absolute;
        left: 640px;
        padding: 2px 2px 0 2px;
        top: 0;
        overflow: scroll;
        max-height: 100vh;
        z-index: 100;
      }
      #upnext-header {
        display: none;
        margin-left: auto;
      }
      @media screen and (max-width: 740px) {
        #right {
          left: initial;
          right: 0;
          max-width: 20%;
          background: #000;
        }
        #upnext {
          display: none;
        }
        #upnext-header {
          display: block;
          margin-bottom: 2px;
        }
        .drawer-open #upnext {
          display: block;
        }
        .drawer-open #left {
          width: 80%;
        }
        .drawer-open #title, .drawer-open #songs {
          width: auto;
        }
      }
  </style>
  </head>
  <body>
    <div id="left">
      <div id="player"></div>
      <p id="title">
        <button id="reset">Reset</button>
        <button id="shuffle">Shuffle</button>
        <button id="next">Next</button>
        <span id="nowplaying"></span>
      </p>
      <div id="songs"></div>
    </div>
    <div id="right">
      <button id="upnext-header">Up next</button>
      <div id="upnext"></div>
    </div>

    <script>
      const parseSeconds = (str) => {
        let seconds = 0
        const [min, sec] = str.split(':').map((v) => parseInt(v, 10))
        if (min) seconds += min * 60
        seconds += sec
        return seconds
      }

      const $el = (t, text = '', props = {}) => {
        const el = document.createElement(t)
        el.innerText = text
        Object.keys(props).forEach((k) => {
          el[k] = props[k]
        })
        return el
      }

      const $ = (sel) => document.querySelector(sel)

      const removeNode = (n) => n.parentNode.removeChild(n);

      const parseVideoTitle = (str) => str.replace(/Live from Quarantine\s+-?/i, '').trim()

      const getTitle = ({video, song}) => `${parseVideoTitle(video.title)} - ${song && song.name || 'All'}`

      const nextItem = (arr, item) => arr[arr.findIndex(i => i === item) + 1]

      const shuffleArray = (a) => {
        let j, x, i;
        for (i = a.length - 1; i > 0; i--) {
            j = Math.floor(Math.random() * (i + 1));
            x = a[i];
            a[i] = a[j];
            a[j] = x;
        }
        return a;
      }

      let player;
      let playing = false;
      let nowPlaying = null;
      let upNext = []
      const DATA = window.__DATA
      const $songs =$('#songs')
      const $upnext = $('#upnext')

      const resetQueue = () => {
        upNext = []
        $upnext.innerHTML = '';
      }

      const addShuffleToQueue = () => {
        resetQueue()
        const shuffledSongs = shuffleArray(DATA.reduce((acc, video) => {
          (video.songs || []).forEach((song) => {
            acc.push({ video, song })
          })
          return acc
        }, []))
        shuffledSongs.forEach((item, index) => {
          if (index === 0) {
            playOrAddToQueue(item)
          } else {
            addToQueue(item)
          }
        })
      }

      const moveToFrontOfQueue = (item) => {
        removeFromQueue(item)
        addToQueue({ video: item.video, song: item.song }, false)
      }

      const removeFromQueue = (item) => {
        const index = upNext.findIndex((i) => i === item)
        upNext.splice(index, 1)
        removeNode($(`#${item.id}`))
      }

      const skipToNextInQueue = () => {
        const next = upNext[0]
        if (next) {
          removeFromQueue(next)
          play(next)
        }
      }

      const playNextInQueue = () => {
        if (upNext.length) {
          skipToNextInQueue()
        } else if (nowPlaying) {
          const { video, song } = nowPlaying
          const next = nextItem(video.songs, song)
          if (next) {
            play({ video, song: next })
          } else {
            const nextVideo = nextItem(DATA, video)
            if (nextVideo) {
              play({ video: nextVideo, song: nextVideo.songs[0] })
            }
          }
        }
      }

      const addToQueue = ({ video, song }, back = true) => {
        const id = `n-${Math.random().toString().slice(2)}`
        const item = { video, song, id }
        const button = $el('button', getTitle({video,song}), {
          id,
          onclick: () => moveToFrontOfQueue(item)
        })
        if (back) {
          upNext.push(item)
          $upnext.appendChild(button)
        } else {
          upNext.unshift(item)
          $upnext.prepend(button)
        }
        console.log(item, upNext.length)
      }

      const play = ({ video, song }) => {
        const v = {
          videoId: video.id,
        }

        if (song) {
          if (song.time.start) {
            v.startSeconds = parseSeconds(song.time.start)
          }
          const next = nextItem(video.songs, song)
          const end = song.time.end || next ? next.time.start : null
          if (end) {
            v.endSeconds = parseSeconds(end)
          }
        }

        console.log('loadVideoById', v)
        $('#nowplaying').innerText = getTitle({video, song})
        nowPlaying = { video, song }

        // debug queue
        // v.endSeconds = v.startSeconds + 10

        player.loadVideoById(v)
      }

      const playOrAddToQueue = ({ video, song }) => {
        console.log('play or up next', playing, upNext.length)
        if (!playing && upNext.length === 0) {
          play({ video, song })
        } else {
          addToQueue({ video, song })
        }
      }

      DATA.forEach(video => {
        $songs.appendChild($el('h2', parseVideoTitle(video.title)))

        if (!video.songs) {
          $songs.appendChild($el('p', 'No timestamps for this video'))
        }

        const $buttonHolder = $el('div')
        $buttonHolder.classList.add('buttons')

        $buttonHolder.appendChild($el('button', '+PLAY ALL+', {
          onclick: () => playOrAddToQueue({ video })
        }))

        ;(video.songs || []).forEach((song) => {
          $buttonHolder.appendChild($el('button', song.name, {
            onclick: () => playOrAddToQueue({
              video,
              song
            })
          }))
        })

        $songs.appendChild($buttonHolder)
      })

      
      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
          height: '390',
          width: '640',
          videoId: DATA[0].id,
          playerVars: { 'autoplay': 0, 'controls': 0 },
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });
      }

      function onPlayerReady(event) {
        console.log('ready', event)
      }

      function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING) {
          console.log('playing', event)
          playing = true
        }
        else if (event.data === YT.PlayerState.ENDED && playing) {
          console.log('ended', event)
          playing = false
          playNextInQueue()
        } else if (event.data === YT.PlayerState.PAUSED) {
          console.log('paused', event)
          playing = false
        }
      }

      $('#shuffle').addEventListener('click', addShuffleToQueue)
      $('#next').addEventListener('click', skipToNextInQueue)
      $('#reset').addEventListener('click', resetQueue)
      $('#upnext-header').addEventListener('click', () => {
        document.body.classList.toggle('drawer-open')
      })
    </script>
  </body>
</html>