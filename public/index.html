<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>AJJ Live From Quarantine</title>
    <script src="parsed.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
      body{
        margin: 0;
        padding: 0;
      }
      #title {
        margin: 0;
        height: 40px;
        width: 640px;
      }
      #songs {
        max-height: calc(100vh - 390px - 40px);
        overflow: scroll;
        width: 640px;
      }
      #songs button, #upnext button {
        display: block;
      }
      #upnext {
        position: absolute;
        left: 641px;
        top: 0;
        overflow: scroll;
        max-height: 100vh;
      }
      #shuffle {
        position: absolute;
        bottom: 0;
        right: 0;
      }
  </style>
  </head>
  <body>
    <div id="player"></div>
    <p id="title">Now playing: <span id="nowplaying"></span> <button id="next">Next</button></p>
    <div id="songs"></div>
    <div id="upnext"></div>
    <button id="shuffle">Shuffle</button>

    <script>
      const parseSeconds = (str) => {
        let seconds = 0
        const [min, sec] = str.split(':').map((v) => parseInt(v, 10))
        if (min) seconds += min * 60
        seconds += sec
        return seconds
      }

      const $el = (t, text, props = {}) => {
        const el = document.createElement(t)
        el.innerText = text
        Object.keys(props).forEach((k) => {
          el[k] = props[k]
        })
        return el
      }

      const removeNode = (n) => n.parentNode.removeChild(n);

      const parseVideoTitle = (str) => str.replace(/Live from Quarantine\s+-?/i, '').trim()

      const getTitle = ({video, song}) => `${parseVideoTitle(video.title)} - ${song && song.name || 'All'}`

      const shuffleArray = (a) => {
        var j, x, i;
        for (i = a.length - 1; i > 0; i--) {
            j = Math.floor(Math.random() * (i + 1));
            x = a[i];
            a[i] = a[j];
            a[j] = x;
        }
        return a;
      }

      let player;
      let playing = false;
      let upNext = []
      const DATA = window.__DATA
      const $songs = document.getElementById('songs')
      const $upnext = document.getElementById('upnext')

      const resetQueue = () => {
        player.stopVideo()
        upNext.forEach((item) => removeFromQueue(item))
      }

      const resetAndShuffle = () => {
        resetQueue()
        const shuffledSongs = shuffleArray(DATA.reduce((acc, video) => {
          (video.songs || []).forEach((song) => {
            acc.push({ video, song })
          })
          return acc
        }, []))
        shuffledSongs.forEach((item, index) => {
          if (index === 0) {
            play(item)
          } else {
            addToQueue(item)
          }
        })
      }

      const addToQueue = ({ video, song }) => {
        const id = `n-${Math.random().toString().slice(2)}`
        const item = {video, song, id }
        upNext.push(item)
        console.log(upNext.length, item)
        $upnext.appendChild($el('button', getTitle({video,song}), { id, onclick: () => removeFromQueue(item) }))
      }

      const removeFromQueue = (item) => {
        const index = upNext.findIndex((i) => i === item)
        upNext.splice(index, 1)
        removeNode(document.getElementById(item.id))
      }

      const playNextInQueue = () => {
        if (upNext.length) {
          player.stopVideo()
          const next = upNext[0]
          removeFromQueue(next)
          play(next)
        }
      }

      const play = ({ video, song }) => {
        const v = {
          videoId: video.resourceId.videoId,
        }

        if (song) {
          if (song.time.start) {
            v.startSeconds = parseSeconds(song.time.start)
          }
          const next = video.songs[video.songs.findIndex(s => s === song) + 1]
          const end = song.time.end || next ? next.time.start : null
          if (end) {
            v.endSeconds = parseSeconds(end)
          }
        }

        console.log('loadVideoById', v)
        document.getElementById('nowplaying').innerText = getTitle({video, song})

        // debug queue
        // v.endSeconds = v.startSeconds + 10

        player.loadVideoById(v)
      }

      const playOrAddToQueue = ({ video, song }) => {
        console.log('play or up next', video, song, upNext.length)
        if (!playing && upNext.length === 0) {
          play({ video, song })
        } else {
          addToQueue({ video, song })
        }
      }

      DATA.forEach(video => {
        $songs.appendChild($el('h2', parseVideoTitle(video.title)))

        if (!video.songs) {
          const noTimestampsMessage = $el('p', 'No timestamps for this video')
          $songs.appendChild(noTimestampsMessage)
        }

        const playAll = $el('button', 'Play whole video', {
          onclick: () => playOrAddToQueue({ video })
        })
        $songs.appendChild(playAll)

        ;(video.songs || []).forEach((song) => {
          const p = $el('button', song.name, {
            onclick: () => playOrAddToQueue({
              video,
              song
            })
          })
          $songs.appendChild(p)
        })
      })

      
      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
          height: '390',
          width: '640',
          videoId: window.__DATA[0].resourceId.videoId,
          playerVars: { 'autoplay': 0, 'controls': 0 },
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });
      }

      function onPlayerReady(event) {
        console.log('ready', event)
      }

      function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING) {
          console.log('playing', event)
          playing = true
        }
        else if (event.data === YT.PlayerState.ENDED && playing) {
          console.log('ended', event)
          playing = false
          playNextInQueue()
        }
      }

      document.getElementById('shuffle').addEventListener('click', resetAndShuffle)
      document.getElementById('next').addEventListener('click', playNextInQueue)
    </script>
  </body>
</html>